<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">

<head>
    <meta charset="utf-8" />
    <title>(print &quot;Lisp Rocks&quot;): 交易軟體中的設計模式 (1) 代理模式與 COM 元件</title>
    <link rel="canonical" href="http://lisp.rocks/posts-output/2023-12-17-交易軟體中的設計模式-1-代理模式與-COM-元件生命週期/">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href='http://fonts.googleapis.com/css?family=Vollkorn' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/github.min.css">
    <link rel="stylesheet" type="text/css" href="https://storage.googleapis.com/app.klipse.tech/css/codemirror.css"> 
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
    <script>
    window.klipse_settings = {
        selector: '.language-klipse' // css selector for the html elements you want to klipsify
    };
    </script>
    <script src="/js/highlight.pack.js" type="text/javascript"></script>
    <script>
    hljs.initHighlightingOnLoad();
    </script>
</head>

<body>
    <nav class="navbar navbar-default">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-title" href="/">(print &quot;Lisp Rocks&quot;)</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse" style="position: absolute; right: 0;">
            <ul class="nav navbar-nav">
                <li ><a href="/">Home</a></li>
                <li ><a href="/archives/">Archives</a></li>
                
                <li >
                    <a href="/pages-output/about/">About</a>
                </li>
                
            </ul>
        </div>
        <!--/.nav-collapse -->
        <!--/.container-fluid -->
    </nav>
    <div>
        <div>
            <div>
                <div id="content">
                    
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        
    </div>
    <h2>交易軟體中的設計模式 (1) 代理模式與 COM 元件</h2>
        <div id="post-date">
            December 17, 2023
        </div>
</div>
<div>
    
    <h1><a name=""></a></h1><p><img src="../../img/not-by-ai/tw/written-by-human/svg/Written-By-Human-Not-By-AI-Badge-white.svg" alt="img" /></p><p><br/></p><h2><a name="代理模式&#95;proxy&#95;pattern"></a>代理模式 Proxy Pattern</h2><p>我們先走一遍，代理模式的結構是如何產生的</p><p>我們現在有一個 <code>Client</code> ，而他的 <code>main&#40;&#41;</code> 會需要使用到 <code>X</code> 的 <code>func&#40;&#41;</code> ：</p><p><img src="../../img/2023-12/proxy_1.png" alt="img" /></p><p>由於 <strong>設計需求</strong> (後面討論)，我們希望 <code>Client</code> 不要直接接觸 <code>X</code></p><p>例如， <code>X</code> 可能還有很多其他函數： <code>unsafeFunc1</code> , <code>unsafeFunc2</code> , <code>unsafeFunc3</code></p><p>但我們不希望 <code>Client</code> 碰到，所以我們先定義一個介面，這個介面只有 <code>func&#40;&#41;</code> ：</p><p><img src="../../img/2023-12/proxy_2.png" alt="img" /></p><p>接著我們依照介面實作 <code>NewX</code> 作為 <code>Client</code> 互動對象，並且只有 <code>func&#40;&#41;</code> 可用：</p><p><img src="../../img/2023-12/proxy_3.png" alt="img" /></p><p>你還可以在 <code>func&#40;&#41;</code> 前後做些準備，讓調用 <code>func&#40;&#41;</code> 之前與之後做好充足準備</p><p>例如透過 <code>beforeFunc&#40;&#41;</code> 檢查傳入的東西是否合法， <code>func&#40;&#41;</code> 是否可以執行</p><p>或是透過 <code>afterFunc&#40;&#41;</code> 把結果做些處理，再返回給 <code>Client</code></p><p>你也可以把 <code>X</code> 的 <code>func&#40;&#41;</code> code 抄過來，讓 <code>Client</code> 與整個 <code>X</code> 解耦</p><p><br/></p><p>然而事情可能沒有那麼簡單， <code>func&#40;&#41;</code> 高度依賴 <code>X</code> 內部的屬性與方法</p><p>那你就必須讓 <code>NewX</code> 持有 (has-a) <code>X</code> ，那這就是最經典的 <strong>組合代理模式</strong> ：</p><p><img src="../../img/2023-12/proxy_4.png" alt="img" /></p><p>這時候 <code>NewX</code> 就是 <code>XProxy</code> ，並持有 <code>X</code> ，透過 <code>self.x.func&#40;&#41;</code> 調用</p><p><br/></p><p>有時候，你可能無法持有 <code>X</code> ，例如 <code>X</code> 在另一個進程、在另一個電腦</p><p>那你就需要在 <code>XProxy</code> 與 <code>X</code> 之間建立通信，考慮 <strong>通信代理模式</strong></p><p>這邊先最簡單的多進程共享 Queue 舉例</p><p>假設 <code>X</code> 在另一個進程中，初始化設置好與 <code>XProxy</code> 共享一個 <code>xqueue</code> ：</p><p><img src="../../img/2023-12/proxy_5.png" alt="img" /></p><p>所以你可以在 <code>XProxy</code> 中透過往 <code>xqueue</code> 放入 args <code>&#40;a, b&#41;</code></p><p>並讓 <code>X</code> 透過對 <code>xqueue</code> 的監聽，取出後執行 <code>func&#40;&#41;</code> ，達成代理的功能</p><p><br/></p><h2><a name="交易軟體中的設計需求：com&#95;元件的生命週期"></a>交易軟體中的設計需求：COM 元件的生命週期</h2><p>如果券商提供的 API 是透過 COM 元件連線，有時候連線中斷後，你可能要重新連線</p><p>然而 COM 元件內部他怎麼紀錄使用狀態你不知道，就可能造成重新連線並沒有把狀態全部重置</p><p>而我們執行的 COM 元件，可能也要重啟 Event loop，然後重新 coInitialize<sup><a id="fnr.1" class="footref" href="#fn.1" role="doc-backlink">1</a></sup></p><p><strong>由於無法確保獲信賴第三方套件，最安全的做法就法就是讓 COM 元件跑在另一個進程</strong> <sup><a id="fnr.2" class="footref" href="#fn.2" role="doc-backlink">2</a></sup></p><p>如果券商 API 執行在另一個進程，那就像是前面的 <code>X</code> 一樣</p><p>我們在主進程中，就得透過 <code>XProxy</code> 來使用 API，並且可以監控 <code>X</code> 的狀況</p><p>而在 API 出問題時，可以透過 <code>XProxy</code> 直接把進程殺死並重啟，確保環境狀態完整重置</p><p>當然，這些都是有附加的代價，設計永遠都是各種權衡</p><p>關於代理模式的優缺點網路上有很多文章，大家需要根據自己的需求自己選擇</p><p><br/></p><h1><a name="footnotes"></a>Footnotes</h1><p><sup><a id="fn.1" href="#fnr.1">1</a></sup> 在 Python 中，得透過 <code>comtypes.CoInitialize</code> 初始化環境，包含確保線程安全、管理生命週期</p><p><sup><a id="fn.2" href="#fnr.2">2</a></sup> 相比之下，多數 DB 的 Client 端是開源的且封裝良好，需要使用到的設計模式是 repository pattern</p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags-output/architecture/">architecture</a>
    
    <a href="/tags-output/trading/">trading</a>
    
    <a href="/tags-output/python/">python</a>
    
    <a href="/tags-output/com/">com</a>
    
</div>


    <div id="prev-next">
        
        <a href="/posts-output/2023-12-18-交易與量化史-1-亞里斯多德的量化金三角/">&laquo; 交易與量化史 (1) 亞里斯多德的量化金三角</a>
        
        
        <a class="right" href="/posts-output/2023-12-16-Python-交易軟體開發如何應對-GIL-移除的未來/">券商交易軟體開發如何應對 3.13 移除 GIL 的未來 — 以 Tkinter 為例 &raquo;</a>
        
    </div>

    
    <div id="disqus_thread"></div>

    <script type="text/javascript">
        var disqus_config = function () {
            this.page.url = "http://lisp.rocks/posts-output/2023-12-17-交易軟體中的設計模式-1-代理模式與-COM-元件生命週期/";
            this.page.identifier = "交易軟體中的設計模式 (1) 代理模式與 COM 元件";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//fatfingererr.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    
</div>

                </div>
            </div>
            <div>
            </div>
        </div>
        <footer>Copyright &copy;  fatfingererr
            <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a> / Design by <a href="http://lambdafunk.com">Lambda Funk</a></p>
        </footer>
    </div>
    <script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
    <script src="https://storage.googleapis.com/app.klipse.tech/plugin/js/klipse_plugin.js"></script>
</body>

</html>